<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn Stock Portfolio Tracker</title>
    <style>
    * {
      margin:0;
      padding:0;
      box-sizing:border-box;
    }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
      background:#0d0d0d;
      color:#e2e8f0;
      line-height:1.6;
      min-height:100vh;
      padding:20px;
    }
    .container {
      max-width:1600px;
      margin:0 auto;
      background:#1a1a1a;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.6);
      overflow:hidden;
    }
    .header {
      background:#1a1a1a;
      border-bottom:1px solid #2d3748;
      padding:32px;
      text-align:center;
    }
    .header h1 {
      font-size:2rem;
      font-weight:600;
      color:#f7fafc;
      margin-bottom:8px;
    }
    .content {
      padding:32px;
    }
    .input-group {
      display:flex;
      gap:12px;
      margin-bottom:20px;
      align-items:center;
    }
    .input-group input {
      flex:1;
      padding:12px 16px;
      border:1px solid #2d3748;
      border-radius:6px;
      font-size:0.95rem;
      background:#111;
      color:#f7fafc;
    }
    .btn {
      padding:12px 24px;
      background:#4299e1;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:0.95rem;
      font-weight:500;
    }
    .loading {
      text-align:center;
      padding:32px;
      color:#a0aec0;
    }
    .error {
      background:#2d1f1f;
      color:#f56565;
      padding:16px;
      border-radius:6px;
      margin-bottom:20px;
      text-align:center;
      border:1px solid #742a2a;
    }
    .table-container {
      margin-top:30px;
      overflow-x:auto;
      border-radius:8px;
      border:1px solid #2d3748;
    }
    table {
      width:100%;
      border-collapse:collapse;
      background:#1a1a1a;
      font-size:0.875rem;
      color:#e2e8f0;
    }
    th {
      background:#2d3748;
      color:#e2e8f0;
      padding:12px 8px;
      text-align:left;
      font-weight:600;
      cursor:pointer;
    }
    td {
      padding:12px 8px;
      border-bottom:1px solid #2d3748;
      vertical-align:top;
    }
    tbody tr:hover {
      background:#111;
    }
    .positive {
      color:#48bb78;
      font-weight:500;
    }
    .negative {
      color:#f56565;
      font-weight:500;
    }
    .stock-symbol {
      font-weight:600;
      color:#edf2f7;
      font-size:0.9rem;
    }
    .stock-name {
      font-size:0.75rem;
      color:#a0aec0;
      margin-top:2px;
      line-height:1.2;
    }
    .shares,.price {
      font-family:'SF Mono',Monaco,'Cascadia Code','Roboto Mono',Consolas,'Courier New',monospace;
      font-weight:500;
      white-space:nowrap;
      color:#f7fafc;
    }
    h2 {
      padding:10px;
      background:#111;
      border-bottom:1px solid #2d3748;
    }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>hypatia</h1>
      </div>
      <div class="content">
        <div class="input-group">
          <input type="password" id="apiKey" placeholder="Enter your Torn API key" />
          <button class="btn" onclick="loadPortfolio()">Load Portfolio</button>
        </div>
        <div id="loading" class="loading" style="display:none;">Loading data...</div>
        <div id="error" class="error" style="display:none;"></div>
        <div id="ownedContainer" class="table-container" style="display:none;">
          <h2>Owned Stocks</h2>
          <table id="ownedTable" data-sort-dir="asc">
            <thead>
              <tr>
                <th onclick="sortTable('ownedTable',0)">Stock</th>
                <th onclick="sortTable('ownedTable',1)">Transaction</th>
                <th onclick="sortTable('ownedTable',2)">Shares</th>
                <th onclick="sortTable('ownedTable',3)">Bought Price</th>
                <th onclick="sortTable('ownedTable',4)">Current Price</th>
                <th onclick="sortTable('ownedTable',5)">Total Value</th>
                <th onclick="sortTable('ownedTable',6)">P&L</th>
                <th onclick="sortTable('ownedTable',7)">P&L %</th>
                <th onclick="sortTable('ownedTable',8)">1H</th>
                <th onclick="sortTable('ownedTable',9)">1D</th>
                <th onclick="sortTable('ownedTable',10)">1W</th>
                <th onclick="sortTable('ownedTable',11)">1M</th>
              </tr>
            </thead>
            <tbody id="ownedTableBody"></tbody>
          </table>
        </div>
        <div id="allContainer" class="table-container" style="display:none;">
          <h2>All Stocks</h2>
          <table id="allTable" data-sort-dir="asc">
            <thead>
              <tr>
                <th onclick="sortTable('allTable',0)">Stock</th>
                <th onclick="sortTable('allTable',1)">Transaction</th>
                <th onclick="sortTable('allTable',2)">Total Shares</th>
                <th onclick="sortTable('allTable',3)">Avg Price</th>
                <th onclick="sortTable('allTable',4)">Current Price</th>
                <th onclick="sortTable('allTable',5)">Market Cap</th>
                <th onclick="sortTable('allTable',6)">Investors</th>
                <th onclick="sortTable('allTable',7)">Per Investor Value</th>
                <th onclick="sortTable('allTable',8)">1H</th>
                <th onclick="sortTable('allTable',9)">1D</th>
                <th onclick="sortTable('allTable',10)">1W</th>
                <th onclick="sortTable('allTable',11)">1M</th>
              </tr>
            </thead>
            <tbody id="allTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <script>
    let apiKey = '';
    window.addEventListener('load',()=>{const saved=localStorage.getItem('tornApiKey'); if(saved){document.getElementById('apiKey').value=saved;}});
    function showLoading(b){document.getElementById('loading').style.display=b?'block':'none';}
    function showError(m){const e=document.getElementById('error'); e.textContent=m; e.style.display='block';}
    function hideError(){document.getElementById('error').style.display='none';}
    function formatNumber(n){return new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);}
    function formatCurrency(n){return '$'+formatNumber(n);}
    function formatPercent(n){const c=n>=0?'positive':'negative'; const s=n>=0?'+':''; return `<span class="${c}">${s}${formatNumber(n)}%</span>`;}
    function formatDate(ts){return new Date(ts*1000).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'});}
    function sortTable(id,col){const t=document.getElementById(id);const rows=Array.from(t.tBodies[0].rows);const asc=t.getAttribute('data-sort-dir')!=='asc';rows.sort((a,b)=>{const A=a.cells[col].innerText.replace(/[$,%]/g,'');const B=b.cells[col].innerText.replace(/[$,%]/g,'');return asc?(parseFloat(A)-parseFloat(B)):(parseFloat(B)-parseFloat(A));});rows.forEach(r=>t.tBodies[0].appendChild(r));t.setAttribute('data-sort-dir',asc?'asc':'desc');}

    async function loadPortfolio(){
      apiKey=document.getElementById('apiKey').value.trim();
      if(!apiKey){showError('Enter API key');return;}
      localStorage.setItem('tornApiKey',apiKey);
      hideError(); showLoading(true);
      document.getElementById('ownedContainer').style.display='none';
      document.getElementById('allContainer').style.display='none';

      try{
        const userResp=await fetch(`https://api.torn.com/user/?selections=stocks&key=${apiKey}`);
        const userData=await userResp.json();
        if(userData.error) throw new Error(userData.error.error);

        const allResp=await fetch(`https://api.torn.com/torn/?selections=stocks&key=${apiKey}`);
        const allData=await allResp.json();

        const ownedRows=[];
        for(const stock of Object.values(userData.stocks||{})){
          for(const tx of Object.values(stock.transactions||{})){
            if(tx.shares % 1000 !== 0){
              const sResp=await fetch(`https://api.torn.com/torn/${stock.stock_id}?selections=stocks&key=${apiKey}`);
              const sData=await sResp.json();
              const sd=sData.stocks[stock.stock_id];
              const cur=sd.current_price; const val=tx.shares*cur; const cost=tx.shares*tx.bought_price; const pl=val-cost; const plp=((cur-tx.bought_price)/tx.bought_price)*100;
              ownedRows.push(`<tr>
<td><div class="stock-symbol">${sd.acronym}</div><div class="stock-name">${sd.name}</div></td>
<td>${formatDate(tx.time_bought)}</td>
<td class="shares">${tx.shares}</td>
<td class="price">${formatCurrency(tx.bought_price)}</td>
<td class="price">${formatCurrency(cur)}</td>
<td class="price">${formatCurrency(val)}</td>
<td class="${pl>=0?'positive':'negative'}">${formatCurrency(pl)}</td>
<td>${formatPercent(plp)}</td>
<td>${sd.last_hour?formatPercent(sd.last_hour.change_percentage):'N/A'}</td>
<td>${sd.last_day?formatPercent(sd.last_day.change_percentage):'N/A'}</td>
<td>${sd.last_week?formatPercent(sd.last_week.change_percentage):'N/A'}</td>
<td>${sd.last_month?formatPercent(sd.last_month.change_percentage):'N/A'}</td>
</tr>`);
            }
          }
        }
        document.getElementById('ownedTableBody').innerHTML=ownedRows.join('');
        if(ownedRows.length) document.getElementById('ownedContainer').style.display='block';

        const allRows=[];
        for(const [id,sd] of Object.entries(allData.stocks||{})){
          const sResp=await fetch(`https://api.torn.com/torn/${id}?selections=stocks&key=${apiKey}`);
          const sData=await sResp.json();
          const d=sData.stocks[id];

          const avgPrice = d.market_cap && d.total_shares ? d.market_cap / d.total_shares : 0;
          const perInvestor = d.market_cap && d.investors ? d.market_cap / d.investors : 0;

          allRows.push(`<tr>
<td><div class="stock-symbol">${d.acronym}</div><div class="stock-name">${d.name}</div></td>
<td>Market</td>
<td class="shares">${d.total_shares.toLocaleString()}</td>
<td class="price">${formatCurrency(avgPrice)}</td>
<td class="price">${formatCurrency(d.current_price)}</td>
<td class="price">${formatCurrency(d.market_cap)}</td>
<td class="shares">${d.investors.toLocaleString()}</td>
<td class="price">${formatCurrency(perInvestor)}</td>
<td>${d.last_hour?formatPercent(d.last_hour.change_percentage):'N/A'}</td>
<td>${d.last_day?formatPercent(d.last_day.change_percentage):'N/A'}</td>
<td>${d.last_week?formatPercent(d.last_week.change_percentage):'N/A'}</td>
<td>${d.last_month?formatPercent(d.last_month.change_percentage):'N/A'}</td>
</tr>`);
        }

        document.getElementById('allTableBody').innerHTML=allRows.join('');
        document.getElementById('allContainer').style.display='block';
        showLoading(false);
      }catch(e){showLoading(false);showError(e.message);}
    }
    document.getElementById('apiKey').addEventListener('keypress',e=>{if(e.key==='Enter'){loadPortfolio();}});
    </script>
  </body>
</html>
